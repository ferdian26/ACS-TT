# Galaxy Viewer database creation tools
This folder contains the necessary tools for processing a text corpus represented as a set of text files,
one per volume, for purposes of creating a database containing data used to drive the Galaxy Viewer visualization.

**Note: Python 3.x is required for running the tools below.**

## Step 1 - Generate the topic model
Use the `create-topic-model.py` tool for running the Mallet topic modeling algorithm on the text corpus of interest.
The important output of this step is a set of files that will be used as input into the next step. Read
note at top of Python script for additional details and warnings.

Alternatively, if no additional stopword removal or token pruning is desired, the same set of output files can be
generated by running Mallet manually directly on the text corpus of interest.

**IMPORTANT:** These scripts were written with support for **Mallet 2.0.8+**. Earlier Mallet versions use a different
format for the 'train-topics --output-doc-topics' output which won't be properly parsed by these scripts.


```
usage: create-topic-model.py [-h] [--mallet-bin PATH]
                             [--remove-stopwords FILE] [--prune-below MIN]
                             [--prune-above MAX] [--num-topics N]
                             [--num-iter N] [--num-workers N] --output DIR
                             glob

Runs Mallet to create the topic model for the provided corpus

positional arguments:
  glob                  The glob pattern specifying the text files that are
                        part of the corpus

optional arguments:
  -h, --help            show this help message and exit
  --mallet-bin PATH     The path of the Mallet startup script (default:
                        mallet)
  --remove-stopwords FILE
                        The path to the stopwords file to use in addition to
                        the default Mallet stopword list (one word per line);
                        if not provided, only the default Mallet stopword list
                        is used (default: None)
  --prune-below MIN     Filter out tokens that appear in less than MIN
                        documents (absolute number) (default: None)
  --prune-above MAX     Filter out tokens that appear in more than MAX percent
                        of documents (0 < MAX < 1) (default: None)
  --num-topics N        The number of topics to generate (default: 100)
  --num-iter N          The number of sampling iterations (default: 1000)
  --num-workers N       The number of parallel workers to use (default: 4)
  --output DIR          The output folder where the results should be written
                        to (default: None)
```

## Step 2 - Compute Galaxy Viewer-specific metrics and statistics
Use the `compute-galaxy.py` tool for processing the output from Step 1 to calculate specific metrics and statistics
needed for the Galaxy Viewer visualization. The output from this step consists of a set of CSV files containing the
augmented topic modeling output.

```
usage: compute-galaxy.py [-h] [--doc-topics FILE] [--topic-keys FILE]
                         [--state FILE] [--max-dict N] --output DIR
                         (--meta META_FILENAME | --solr SOLR_URL)

Performs auxiliary computation on Mallet output for use in the Galaxy Viewer

optional arguments:
  -h, --help            show this help message and exit
  --doc-topics FILE     The file containing the topic proportions per document
                        (default: doctopics.txt)
  --topic-keys FILE     The file containing the top words for each topic and
                        any Dirichlet parameters (default: topickeys.txt)
  --state FILE          The file containing the Gibbs sampling state produced
                        by Mallet (default: state.mallet.gz)
  --max-dict N          The maximum number of tokens allowed in the
                        dictionary; the top N tokens will be used, all others
                        will be pruned. This is needed due for scalability
                        reasons since some computations scale with the size of
                        the dictionary. Use N=0 if you want to disable the
                        pruning, but expect the running time to increase
                        significantly. (default: 2000)
  --output DIR          The output folder where the results should be written
                        to (default: None)
  --meta META_FILENAME  The metadata CSV file containing info about each
                        document (at a minimum, the columns must contain
                        'source', 'title', 'publishDate' - where 'source' must
                        correlate with the 'source' (2nd) column from the '--
                        doc-topics' file) (default: None)
  --solr SOLR_URL       The SOLR base URL to use for looking up document
                        metadata (default: None)
```

## Step 3 - Load data into database
Use the `create-galaxy-db.py` tool for creating a database based on the output from Step 2. After this process the
Galaxy Viewer visualization that's connected to the API endpoint linked to this database will reflect the newly-loaded
dataset, and will be ready for displaying it.

```
usage: create-galaxy-db.py [-h] [--dist DISTANCE_FILENAME]
                           [--docs DOCUMENTS_FILENAME]
                           [--state STATE_FILENAME] [--tokens TOKENS_FILENAME]
                           [--topics TOPICS_FILENAME] --name DATASET_NAME
                           [--mongo MONGO_URI] [--dbname DBNAME]
                           [--meta META_FILENAME]

Converts data created by the GalaxyViewer backend R scripts to Javascript
files for ingestion into MongoDB

optional arguments:
  -h, --help            show this help message and exit
  --dist DISTANCE_FILENAME
                        The topic distance CSV file (default: distance.csv)
  --docs DOCUMENTS_FILENAME
                        The CSV file containing topic allocations for each
                        document (default: documents.csv)
  --state STATE_FILENAME
                        The Mallet state CSV file (default: state.csv)
  --tokens TOKENS_FILENAME
                        The CSV file containing id <-> token mapping (default:
                        tokens.csv)
  --topics TOPICS_FILENAME
                        The topics CSV file (default: topics.csv)
  --name DATASET_NAME   The name of the dataset (default: None)
  --mongo MONGO_URI     The URI of the MongoDB instance to use (default:
                        mongodb://localhost:27017/)
  --dbname DBNAME       The name of the database to use (default:
                        galaxyviewer)
  --meta META_FILENAME  The metadata file containing info about each document
                        (default: docmeta.csv)
```